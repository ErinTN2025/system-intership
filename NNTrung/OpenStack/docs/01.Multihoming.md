# Multihoming
### Vấn đề không ping được cả 2 Card mạng
- Một máy chủ có nhiều card mạng kết nối vào các lớp mạng khác nhau
- Cách kiểm tra: `ip route show`

![altimage](../Images/Screenshot_1.png)

**Vấn đề về "Default Gateway" và Metric**
- `eth0 (192.168.20.1)` với metric 100
- `eth1 (192.168.70.1)` với metric 101

Trong Linux, hệ thống sẽ ưu tiên đường có metric thấp hơn. Vì vậy, mọi gói tin đi ra ngoài (Internet hoặc các mạng không nằm trong dải trực tiếp) sẽ luôn chọn eth0. Nếu bạn đang đứng từ một mạng bên ngoài ping vào IP `192.168.70.114`, gói tin đi vào qua eth1, nhưng phản hồi (Reply) lại tìm đường ngắn nhất để đi ra là eth0. Điều này gây ra hiện tượng Asymmetric Routing (định tuyến không đối xứng) và thường bị tường lửa hoặc chính hệ điều hành chặn lại.

**Cơ chế Reverse Path Filtering (rp_filter)**

Đây là nguyên nhân phổ biến nhất trên Rocky Linux/RHEL. Linux có một tính năng bảo mật kiểm tra xem gói tin đi vào và đi ra có cùng một interface hay không.
- Gói tin vào: e`th1`
- Gói tin phản hồi muốn ra: `eth0` (do metric thấp hơn)
- Kết quả: Kernel coi đây là giả mạo và hủy gói tin.

## Cách khắc phục
###  Kiểm tra đường truyền ngược
```bash
sudo sysctl -w net.ipv4.conf.all.rp_filter=0
sudo sysctl -w net.ipv4.conf.eth1.rp_filter=0
```
- Việc lệnh hiện ra kết quả như vậy có nghĩa là bạn thực thi thành công việc tắt cơ chế kiểm tra gói tin ngược (Reverse Path Filtering) một cách tạm thời.
- Nếu vẫn chưa ping được: Có thể vấn đề nằm ở Firewall hoặc do cấu hình Metric vẫn đang ưu tiên `eth0` quá mức khiến gói tin không biết đường về.

### Cấu hình Policy Based Routing (Giải pháp triệt để)
Để máy tính biết rằng "nếu gói tin đến từ cổng eth1 thì phải trả về qua cổng eth1", bạn cần tạo một bảng định tuyến riêng cho nó.
- **Tạo bảng định tuyến mới:**
```bash
echo "200 custom_eth1" | sudo tee -a /etc/iproute2/rt_tables
```
  - `[Số thứ tự] [Tên bảng]`: Số thứ tự hoàn toàn có thể chọn từ 1 đến 252.
  - **255 local**: Chứa các đường đi đến địa chỉ IP của chính máy đó và các địa chỉ Broadcast. Khi bạn 
  - **254 main**: Đây là bảng quan trọng nhất. Khi bạn gõ ip route show mà không thêm tham số gì, bạn đang xem bảng này. Nó chứa tất cả các đường đi mặc định cho mạng LAN và Internet.
  - **253 default**: Một bảng trống dự phòng, thường dùng cho các gói tin không khớp với bất kỳ quy tắc nào trong bảng `main` và `local`.
  - **0 unspec**: Đại diện cho việc chưa xác định (unspecified).

- **Bình thường (Chỉ có bảng `main`)**: Máy chỉ có một bản đồ duy nhất. Nếu bản đồ bảo đi ra bằng cổng eth0, thì dù gói tin có đến từ eth1, nó vẫn cố đi ra bằng eth0. Điều này gây ra lỗi ping mà bạn gặp lúc đầu.

- **Khi có bảng `custom_eth1`**: Bạn tạo ra một bản đồ riêng. Bạn có thể ra lệnh cho Linux rằng: "Nếu gói tin đi ra từ địa chỉ IP của eth1, đừng nhìn vào bản đồ chung nữa, hãy nhìn vào bản đồ số 200 này."

**Để bảng này hoạt động cần thêm 2 bước nữa**
- Thêm đường đi vào bảng `200`: Bảo nó rằng cổng thoát của bảng này là `192.168.70.1`.
- Tạo luật (Rule): Bảo hệ thống khi nào thì cần mở bảng `200` ra xem.
- **Thêm luật cho bảng đó**
```bash
ip route add 192.168.70.0/24 dev eth1 table custom_eth1
ip route add default via 192.168.70.1 dev eth1 table custom_eth1

# Ép các gói tin từ IP .114 phải dùng bảng này
ip rule add from 192.168.70.114 table custom_eth1
```
- Tường lửa (Firewalld): Hãy chắc chắn rằng bạn đã cho phép giao thức ICMP trên cả hai zone của `eth0` và `eth1`. sudo `firewall-cmd --get-active-zones` để kiểm tra xem eth1 đang nằm ở zone nào.
