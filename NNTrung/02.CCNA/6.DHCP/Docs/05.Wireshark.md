# WireShark
## 1. Khái niệm về WireShark
- **Wireshark** là một công cụ phân tích mạng và ghi lại giao thức mạng. Nó cho phép người dùng theo dõi và phân tích các gói tin mạng trong thời gian thực. Wireshark có khả năng xem và phân tích dữ liệu trong các giao thức
mạng phổ biến như TCP, UDP, IP, HTTP và nhiều giao thức khác.

Với Wireshark, người dùng có thể xem các gói tin mạng được truyền qua mạng, xác định nguồn gốc và đích của các gói tin, kiểm tra nội dung và cấu trúc của các giao thức, và phân tích lưu lượng mạng để tìm hiểu về hiệu suất và vấn đề liên quan đến mạng.

## 2. Phần mềm WireShark dùng để làm gì?
- **Xác định vấn đề**: Phát hiện kết nối chậm, rớt gói, lỗi cấu hình.
- **Phân tích bảo mật**: Phát hiện truy cập bất thường, hành vi phần mềm độc hài, quét cổng.
- **Nghiên cứu giao thức**: Hiểu sâu cách thức hoạt động của các giao thức mạng
## 3. Phần mềm WireShark hoạt động thế nào
**Wireshark** hoạt động ngay khi được cài đặt trên thiết bị nhưng bạn cần cài đặt mạng phù hợp với hệ thống mạng đang dùng. Wireshark thực hiện thu thập tất cả các địa chỉ IP đã được kết nối với hệ thống mạng. Mỗi khi có thiết bị sử dụng mạng được kết nối, chúng sẽ được cập nhật trong các gói dữ liệu mà Wireshark thu thập được.

**Các bước hoạt động cơ bản**:
  - **Bắt gói tin(Packet Capture)**:  Wireshark lắng nghe lưu lượng mạng trên một giao diện (ví dụ: Ethernet, Wi-Fi). Sử dụng driver chuyên dụng, nó nắm bắt các gói tin mạng theo thời gian thực. Có thể dùng Capture Filters để chỉ bắt những gói tin thỏa điều kiện, giảm tải dữ liệu.
  - **Hiển thị và Giải mã(Display & Decode)**: Các gói tin được bắt sẽ xuất hiện trong bảng danh sách, được tô màu sắc khác nhau theo giao thức. Wireshark giải mã cấu trúc gói tin (Ethernet, IP, TCP/UDP, HTTP, DNS...) và hiển thị chi tiết theo từng lớp trong bảng giữa (Packet Details).
  - **Lọc và tìm kiếm**: Wireshark cung cấp khả năng lọc và tìm kiếm dựa trên các tiêu chí như địa chỉ IP, cổng, giao thức, dữ liệu và nhiều tiêu chí khác.
  - **Phân tích(Analysis)**: 
    - **Display Filters**: Lọc các gói tin đã bắt để chỉ xem những gì quan tâm. 
    - **Xem byte thô (Packet Bytes)**: Bảng dưới cùng hiển thị dữ liệu ở dạng thập lục phân (hex) để phân tích sâu hơn. 
    - **Theo dõi luồng (Follow Stream)**: Theo dõi toàn bộ cuộc hội thoại giữa hai điểm (ví dụ: TCP Stream). 
    - **Thống kê**: Tạo các báo cáo, biểu đồ về lưu lượng mạng. 
  - **Xuất và chia sẻ dữ liệu**: Phần mềm cho phép xuất dữ liệu phân tích thành các định dạng như CSV, XML hoặc JSON để tạo báo cáo hoặc chia sẻ thông tin với người khác.
## 4. Sử dụng phần mềm
### 1. Tải & cài đặt phần mềm ứng dụng

![altimage](../Images/wiresharkdownload.png)

```bash
sudo apt update
sudo apt install wireshark -y
```
Trong lúc cài, hệ thống sẽ hỏi:
```bash
Allow non-superusers to capture packets?
```
Sau đó thêm User vào Wireshark
- Chọn Yes để user nào cũng có thể bắt gói không bắt buộc phải sudo
```bash
sudo usermod -aG wireshark $USER
newgrp wireshark
```

-> Chạy Wireshark

![altimage](../Images/wireshark1.png)
### 2. Cách sử dụng Wireshark
- Mở ứng dụng Wireshark trên máy tính.
- Chọn một giao diện mạng để chụp gói tin từ danh sách giao diện có sẵn

![altimage](../Images/wireshark2.png)

- Lưu lượng hiển thị qua `ens3` được hiển thị

![altimage](../Images/wireshark3.png)

- Ta thấy giao diện WireShark được chia làm 3 phần chính :
  - **Packet list**: Hiển thị các gói tin bắt được trên 1 card mạng, mỗi gói tin là một dòng được đánh số theo thứ tự.

  ![altimage](../Images/wireshark4.png)

  - **Packet details**: Hiển thị thông tin chi tiết của 1 gói tin được chọn.

  ![altimage](../Images/wireshark5.png)

  - **Packet bytes**: Hiển thị dữ liệu thô của gói tin dưới dạng hex hoặc ASCII, giúp xem chi tiết nội dung thực tế, tìm kiếm thông tin nhạy cảm như (mật khẩu) trong các giao thức không mã hóa như HTTP

  ![altimage](../Images/wireshark6.png)

### 3. Ý nghĩa màu sắc các gói tin trong WireShark
Để xem ý nghĩa màu sắc các gói tin trong WireShark: Chọn `view` -> `Colouring Rules`

![altimage](../Images/wireshark7.png)

- **`Bad TCP`**: Nền đỏ chữ cam
  - `tcp.analysis.flags`: cờ này được bật khi gói TCP thuộc nhóm bất thường
  - `!tcp.analysis.window_update`: không phải là window update
  - `!tcp.analysis.keep_alive`: không phải là tcp keep alive
  - `!tcp.analysis.keep_alive_ack`: không phải là các gói trả lời cho tcp keep alive

| **Tên nhóm bất thường**| **Ý nghĩa**|
|------------------------|------------|
| Retransmission | Gửi lại một segment TCP do không nhận được ACK hoặc bị timeout |
| Out of order | Segment TCP đến không đúng thứ tự so với sequence number |
| Zero Window | Server hết buffer nhận, yêu cầu bên gửi tạm dừng truyền dữ liệu |

Nhìn thấy màu này = mạng có vấn đề

**`TCP RST` / `SCTP ABORT`**: Nền đỏ chữ vàng

**`ICMP errors`**: Nền đen, chữ xanh

**`TTL/hop limit thấp`**: Nền đỏ, chữ trắng

**`TCP` thông thường**: Nền tím nhạt, chữ đen
  - `tcp` bình thường, không có lỗi

**`UDP`**: Nền xanh dương nhạt, chữ đen

**`HTTP`**: Nền xanh lá nhạt, chữ đen

**`ICMP`**: Nền hồng nhạt, chữ đen

**`ARP`**: Nền màu da nhạt, chữ đen

**`Routing`**: Nền màu cam nhạt, chữ đen

### 4. Sử dụng Filter (Ctrl + F) để lọc gói tin
- Bắt gói tin có Source IP là `192.168.148.130`

![altimage](../Images/findip.png)

# CAPTURE GÓI TIN DHCP BẰNG WIRESHARK

## 1. Capture bằng WireShark
Ta sử dụng DHCP server là ubuntu và DHCP client là CentOS để tạo gói tin về nguyên lý hoạt động của DHCP:
  - Trên CentOS ta xin cấp phát IP 

```bash
dhclient -v ens160
```
hoặc 
Vì máy đã có DHCP lease cũ

NetworkManager sẽ:
  - Không gửi Discover
  - Không chờ Offer
  - Gửi luôn DHCP Request(unicast) để xin lại IP cũ
  - Server trả DHCP ACK
```bash
sudo rm -f /var/lib/NetworkManager/*.lease
sudo systemctl restart NetworkManager
```
Sử dụng Wireshark để theo dõi các gói tin dhcp đã được trao đổi

![altimage](../Images/dhcp2.png)

### 1.2 Gói DHCP discover

![altimage](../Images/dhcpdiscover.png)

Tầng 2:
  - source MAC: `VMware_39:82:0e`  Địa chỉ MAC cua máy client(máy xin cấp IP)
  - dest MAC: `Broadcast`: gửi tất cả thiết bị trong LAN

Tầng 3: 
  - source IP: `0.0.0.0` (do client chưa có ip nên ip nguồn sẽ là `0.0.0.0`)
  - dest IP: `255.255.255.255` (broadcast toàn mạng -> để tìm DHCP server)

Tầng 4: UDP
  - Source port: `68` (DHCP client)
  - dest port: `67` (DHCP server)

Tầng ứng dụng: DHCP(Discover)
  - Đây là gói đầu tiên trong quá trình DORA, client đang tìm kiếm DHCP server
  - Đây là broadcast không có IP, chỉ có MAC -> DHCP server sẽ phản hồi bừng gói `Offer`

### 1.3 Gói DHCP offer

![altimage](../Images/offer.png)

Tầng 2:

- source MAC: `VMware_cf:87:99` (địa chỉ MAC của DHCP server)
- dest MAC: `VMware_39:82:0e` (địa chỉ MAC của client)

Tầng 3:

- source IP: `192.168.172.10` (địa chỉ IP của server)
- dest IP: `192.168.174.15` - IP được đề xuất cho client

Tầng 4:

- source port: `67` (DHCP server)
- dest port: `68` (DHCP client)

Tầng ứng dụng: DHCP(Offer)

- Message type: Boot reply(2) -> phản hồi từ server
- Your(client) IP address: `192.168.60.51` -> IP được cấp phát cho client
- IP address lease time: thời gian thuê IP
- subnet mask, router, dns, ...

### 1.4 Gói DHCP Request

![altimage](../Images/request.png)

Tầng 2:

- source MAC: `VMware_39:82:0e` - địa chỉ MAC của DHCP client
- dest MAC: broadcast

Tầng 3:

- source IP: `0.0.0.0` -> vì client chưa có IP
- dest IP: `255.255.255.255` -> gửi broadcast để DHCP server nào gửi offer biết là được chọn

Tầng 4:

- source port: `68` -> DHCP client
- dest port: `67` -> DHCP server

Tầng ứng dụng: DHCP (request)

- Message type: `request` -> DHCP client chọn một offer từ server (gói offer) và gửi lại yêu cầu xác nhận sử dụng IP đó
- Request IP address: IP mà client muốn nhận (do server đề xuất trước đó)
- Parameter Request List: Client yêu cầu các tùy chọn cấu hình từ server (DNS, gateway, lease time, ...)

### 1.5 Gói DHCP AcK

![altimage](../Images/ackdhcp.png)

Tầng 2:

- source MAC: `VMware_cf:87:99` (địa chỉ MAC của DHCP server)
- dest MAC: `VMware_39:82:0e` (địa chỉ MAC của client)

Tầng 3:

- source IP: `192.168.172.10` - IP của server
- dest IP: `192.168.172.15` - IP được gán cho client

Tầng 4:

- source IP: `67` - DHCP server
- dest IP: `68` - DHCP client

Tầng ứng dụng: DHCP(ack)

- Message type: `ACK` -> DHCP server xác nhận và chính thức cấp phát IP được client chọn trong gói request
- Các DHCP option:
  - IP được cấp
  - IP lease time
  - default gateway
  - DNS server
  - subnet mask

#### Option nhận dạng & điều khiển

| Code | Tên Option             | Ý nghĩa                                      |
| ---- | ---------------------- | -------------------------------------------- |
| 53   | DHCP Message Type      | Loại gói DHCP(Discover, Offer, Request, Ack) |
| 61   | Client Identifier      | Định danh client                             |
| 50   | Requested IP Address   | IP client muốn                               |
| 51   | IP Address Lease Time  | Thời gian thuê IP                            |
| 54   | Server Identifier      | IP DHCP Server                               |
| 55   | Parameter Request List | Client yêu cầu option nào                    |

#### Option cấu hình mạng

| Code | Tên Option               |
| ---- | ------------------------ |
| 1    | Subnet Mask              | 
| 3    | Router (Default Gateway) |
| 6    | DNS Server               |
| 15   | Domain Name              |
| 28   | Broadcast Address        |